rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    function isSignedIn() {
      return request.auth != null;
    }

    match /salon_setup_progress/{salonId} {
      allow read: if isSignedIn() && canReadSalonDocument(salonId);
      allow create, update, delete: if isSignedIn() && canManageSalonDocument(salonId);
    }

    function currentUserDoc() {
      return isSignedIn()
          ? get(/databases/$(database)/documents/users/$(request.auth.uid))
          : null;
    }

    function currentUserData() {
      return currentUserDoc() != null ? currentUserDoc().data : null;
    }

    function currentUserRole() {
      return currentUserData() != null && currentUserData().role is string
          ? currentUserData().role
          : null;
    }

    function isAdmin() {
      return currentUserRole() == 'admin';
    }

    function isStaff() {
      return currentUserRole() == 'staff';
    }

    function isClient() {
      return currentUserRole() == 'client';
    }

    function isAdminOrStaff() {
      return isAdmin() || isStaff();
    }

    function currentSalonIds() {
      let data = currentUserData();
      return data == null
          ? []
          : data.salonIds is list
              ? data.salonIds
              : data.salonId is string
                  ? [data.salonId]
                  : [];
    }

    function hasSalonAccess(salonId) {
      return salonId is string && currentSalonIds().hasAny([salonId]);
    }

    function canReadSalonDocument(salonId) {
      return hasSalonAccess(salonId) && (isAdmin() || isStaff() || isClient());
    }

    function canManageSalonDocument(salonId) {
      return (isAdmin() || isStaff()) && hasSalonAccess(salonId);
    }

    function canViewAllSalons() {
      return isSignedIn() &&
          (currentSalonIds().size() == 0 || !isUserInitialized());
    }

    function currentClientId() {
      let data = currentUserData();
      return data != null && data.clientId is string ? data.clientId : null;
    }

    function isOwnClient(clientId) {
      return isClient() && currentClientId() != null && currentClientId() == clientId;
    }

    function appointmentDocument(appointmentId) {
      return get(/databases/$(database)/documents/appointments/$(appointmentId));
    }

    function appointmentSalonId(appointmentId) {
      let doc = appointmentDocument(appointmentId);
      return doc != null && doc.data != null && doc.data.salonId is string
          ? doc.data.salonId
          : null;
    }

    function appointmentClient(appointmentId) {
      let doc = appointmentDocument(appointmentId);
      return doc != null && doc.data != null && doc.data.clientId is string
          ? doc.data.clientId
          : null;
    }

    function isUserInitialized() {
      return currentUserRole() != null;
    }

    function resourceSalonId() {
      return resource != null && resource.data != null && resource.data.salonId is string
          ? resource.data.salonId
          : null;
    }

    function requestSalonId() {
      return request.resource != null && request.resource.data != null &&
          request.resource.data.salonId is string
          ? request.resource.data.salonId
          : null;
    }

    function requestClientId() {
      return request.resource != null && request.resource.data != null &&
          request.resource.data.clientId is string
          ? request.resource.data.clientId
          : null;
    }

    function requestTemplateId() {
      return request.resource != null && request.resource.data != null &&
          request.resource.data.templateId is string
          ? request.resource.data.templateId
          : null;
    }

    function isStaffSortOrderUpdate() {
      return isStaff() &&
          canManageSalonDocument(resourceSalonId()) &&
          request.resource != null &&
          request.resource.data != null &&
          resource != null &&
          resource.data != null &&
          request.writeFields.hasOnly(['sortOrder']) &&
          request.resource.data.sortOrder is int &&
          request.resource.data.salonId == resourceSalonId();
    }

    function requestQuoteStatus() {
      return request.resource != null && request.resource.data != null &&
          request.resource.data.status is string
          ? request.resource.data.status
          : null;
    }

    function isCartStatusEditable(status) {
      return status is string && ['pending', 'submitted', 'failed'].hasAny([status]);
    }

    function quoteDecisionAllowedForClient() {
      return resource != null && resource.data != null &&
          resource.data.clientId is string &&
          isOwnClient(resource.data.clientId) &&
          request.resource != null && request.resource.data != null &&
          request.resource.data.salonId == resource.data.salonId &&
          request.resource.data.clientId == resource.data.clientId &&
          request.resource.data.number == resource.data.number &&
          request.resource.data.title == resource.data.title &&
          request.resource.data.notes == resource.data.notes &&
          request.resource.data.items == resource.data.items &&
          request.resource.data.total == resource.data.total &&
          request.resource.data.sentChannels == resource.data.sentChannels &&
          request.resource.data.pdfStoragePath == resource.data.pdfStoragePath &&
          request.resource.data.validUntil == resource.data.validUntil &&
          request.resource.data.createdAt == resource.data.createdAt &&
          request.resource.data.sentAt == resource.data.sentAt &&
          request.resource.data.diff(resource.data).addedKeys().hasOnly([]) &&
          request.resource.data.diff(resource.data).removedKeys().hasOnly([]) &&
          (
            (
              requestQuoteStatus() == 'accepted' &&
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'acceptedAt', 'updatedAt', 'ticketId']) &&
              request.resource.data.acceptedAt is timestamp &&
              request.resource.data.updatedAt is timestamp &&
              request.resource.data.ticketId is string &&
              request.resource.data.ticketId.size() > 0
            ) ||
            (
              requestQuoteStatus() == 'declined' &&
              request.resource.data.diff(resource.data).changedKeys().hasOnly(['status', 'declinedAt', 'updatedAt']) &&
              request.resource.data.declinedAt is timestamp &&
              request.resource.data.updatedAt is timestamp
            )
          );
    }

    function dataSalonIds(data) {
      return data == null
          ? []
          : data.salonIds is list
              ? data.salonIds
              : data.salonId is string
                  ? [data.salonId]
                  : [];
    }

    function resourceSalonIdsList() {
      return resource != null && resource.data != null
          ? dataSalonIds(resource.data)
          : [];
    }

    function requestSalonIdsList() {
      return request.resource != null && request.resource.data != null
          ? dataSalonIds(request.resource.data)
          : [];
    }

    function isStaffUserData(data) {
      return data != null && data.role is string && data.role == 'staff';
    }

    function hasValidQuestionnaireTemplatePayload(data) {
      return data != null &&
          data.salonId is string && data.name is string &&
          (data.description == null || data.description is string) &&
          (data.isDefault == null || data.isDefault is bool) &&
          data.groups is list;
    }

    function hasValidQuestionnairePayload(data) {
      return data != null && data.salonId is string && data.clientId is string &&
          data.templateId is string && data.answers is map;
    }





    match /users/{userId} {
      allow get: if isSignedIn() && (
        request.auth.uid == userId ||
        ((isAdmin() || isStaff()) && resource != null && resource.data != null && (
          (resource.data.salonIds is list && currentSalonIds().hasAny(resource.data.salonIds)) ||
          (resource.data.salonId is string && hasSalonAccess(resource.data.salonId))
        ))
      );

      allow list: if isSignedIn() && (isAdmin() || isStaff());

      allow create: if isSignedIn() && (
        request.auth.uid == userId ||
        (isAdmin() &&
            request.resource != null &&
            request.resource.data is map &&
            isStaffUserData(request.resource.data) &&
            requestSalonIdsList().size() > 0 &&
            requestSalonIdsList().hasOnly(currentSalonIds()))
      );

      allow update: if isSignedIn() && (
        request.auth.uid == userId ||
        (isAdmin() &&
            request.resource != null &&
            request.resource.data is map &&
            resource != null &&
            resource.data is map &&
            isStaffUserData(request.resource.data) &&
            isStaffUserData(resource.data) &&
            requestSalonIdsList().size() > 0 &&
            requestSalonIdsList().hasOnly(currentSalonIds()) &&
            resourceSalonIdsList().hasOnly(currentSalonIds()))
      );

      allow delete: if isSignedIn() && (
        request.auth.uid == userId ||
        (isAdmin() &&
            resource != null &&
            resource.data is map &&
            isStaffUserData(resource.data) &&
            resourceSalonIdsList().hasOnly(currentSalonIds()))
      );
    }

    match /salons/{salonId} {
      allow read: if isSignedIn() && ((isAdmin() && hasSalonAccess(salonId)) || canViewAllSalons());
      allow create: if isSignedIn() && isAdmin();
      allow update, delete: if isSignedIn() && isAdmin() && canReadSalonDocument(salonId);
    }

    match /staff/{staffId} {
      allow read: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow create: if isSignedIn() && (
        (isAdmin() && canManageSalonDocument(requestSalonId())) ||
        (!isUserInitialized() && requestSalonId() is string)
      );
      allow update: if isSignedIn() && (
        (isAdmin() && canManageSalonDocument(resourceSalonId())) ||
        isStaffSortOrderUpdate()
      );
      allow delete: if isSignedIn() && isAdmin() && canManageSalonDocument(resourceSalonId());
    }

    match /staff_roles/{roleId} {
      allow read: if isSignedIn() && (
        isAdmin() ||
        (resourceSalonId() != null && canReadSalonDocument(resourceSalonId())) ||
        (resourceSalonId() == null && isStaff())
      );

      allow create, update, delete: if isSignedIn() && isAdmin();
    }

    match /client_questionnaire_templates/{templateId} {
      allow get: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow list: if isSignedIn() && isAdminOrStaff();

      allow create: if isSignedIn() && isAdminOrStaff() &&
          canManageSalonDocument(requestSalonId()) &&
          hasValidQuestionnaireTemplatePayload(request.resource.data);

      allow update: if isSignedIn() && isAdminOrStaff() &&
          canManageSalonDocument(resourceSalonId()) &&
          requestSalonId() == resourceSalonId() &&
          hasValidQuestionnaireTemplatePayload(request.resource.data);

      allow delete: if isSignedIn() && isAdminOrStaff() &&
          canManageSalonDocument(resourceSalonId());
    }

    match /client_questionnaires/{questionnaireId} {
      allow get: if isSignedIn() && (
        canReadSalonDocument(resourceSalonId()) ||
        (isClient() && isOwnClient(resource != null ? resource.data.clientId : null))
      );

      allow list: if isSignedIn() && isAdminOrStaff();

      allow create: if isSignedIn() && isAdminOrStaff() &&
          canManageSalonDocument(requestSalonId()) &&
          hasValidQuestionnairePayload(request.resource.data) &&
          requestTemplateId() != null &&
          exists(
            /databases/$(database)/documents/client_questionnaire_templates/$(requestTemplateId())
          ) &&
          get(
            /databases/$(database)/documents/client_questionnaire_templates/$(requestTemplateId())
          ).data.salonId == requestSalonId();

      allow update: if isSignedIn() && isAdminOrStaff() &&
          canManageSalonDocument(resourceSalonId()) &&
          hasValidQuestionnairePayload(request.resource.data) &&
          resource.data.clientId == request.resource.data.clientId &&
          resource.data.salonId == request.resource.data.salonId &&
          request.resource.data.templateId == resource.data.templateId &&
          requestTemplateId() != null &&
          exists(
            /databases/$(database)/documents/client_questionnaire_templates/$(requestTemplateId())
          ) &&
          get(
            /databases/$(database)/documents/client_questionnaire_templates/$(requestTemplateId())
          ).data.salonId == request.resource.data.salonId;

      allow delete: if isSignedIn() && isAdminOrStaff() &&
          canManageSalonDocument(resourceSalonId());
    }

    match /clients/{clientId} {
      allow read: if isSignedIn() && (
        (resourceSalonId() != null && canManageSalonDocument(resourceSalonId())) ||
        isOwnClient(clientId)
      );

      allow create: if isSignedIn() && (
        ((isAdmin() || isStaff()) && canManageSalonDocument(requestSalonId())) ||
        (!isUserInitialized() && requestSalonId() is string) ||
        (isClient() && currentClientId() == null && requestSalonId() is string) ||
        (isOwnClient(clientId) && requestSalonId() != null && hasSalonAccess(requestSalonId()))
      );

      allow update: if isSignedIn() && (
        ((isAdmin() || isStaff()) && resourceSalonId() != null &&
            canManageSalonDocument(resourceSalonId()) &&
            requestSalonId() == resourceSalonId()) ||
        (isOwnClient(clientId) && resourceSalonId() != null &&
            requestSalonId() == resourceSalonId() && hasSalonAccess(resourceSalonId()))
      );

      allow delete: if isSignedIn() && (isAdmin() || isStaff()) &&
          resourceSalonId() != null && canManageSalonDocument(resourceSalonId());
    }

    match /salon_access_requests/{requestId} {
      allow read: if isSignedIn() && (
        (resource != null && resource.data != null &&
            resource.data.salonId is string &&
            canManageSalonDocument(resource.data.salonId)) ||
        (request.auth != null &&
            resource != null && resource.data != null &&
            resource.data.userId is string &&
            resource.data.userId == request.auth.uid)
      );

      allow create: if isSignedIn() &&
          request.auth != null &&
          request.resource != null && request.resource.data != null &&
          request.resource.data.userId is string &&
          request.resource.data.userId == request.auth.uid &&
          request.resource.data.salonId is string &&
          request.resource.data.firstName is string &&
          request.resource.data.lastName is string &&
          request.resource.data.email is string &&
          request.resource.data.phone is string &&
          (request.resource.data.dateOfBirth == null ||
              request.resource.data.dateOfBirth is timestamp) &&
          (request.resource.data.extraData == null ||
              request.resource.data.extraData is map) &&
          request.resource.data.status == 'pending';

      allow update: if isSignedIn() &&
          request.resource != null && request.resource.data != null &&
          resource != null && resource.data != null &&
          resource.data.salonId is string &&
          canManageSalonDocument(resource.data.salonId) &&
          request.resource.data.userId == resource.data.userId &&
          request.resource.data.salonId == resource.data.salonId &&
          request.resource.data.firstName == resource.data.firstName &&
          request.resource.data.lastName == resource.data.lastName &&
          request.resource.data.email == resource.data.email &&
          request.resource.data.phone == resource.data.phone &&
          resource.data.status == 'pending' &&
          (request.resource.data.status == 'approved' ||
              request.resource.data.status == 'rejected') &&
          (request.resource.data.clientId == null ||
              request.resource.data.clientId is string) &&
          (request.resource.data.extraData == null ||
              request.resource.data.extraData is map) &&
          (request.resource.data.dateOfBirth == null ||
              request.resource.data.dateOfBirth is timestamp) &&
          (request.resource.data.updatedAt == null ||
              request.resource.data.updatedAt is timestamp) &&
          request.resource.data.createdAt == resource.data.createdAt;

      allow delete: if false;
    }


    match /services/{serviceId} {
      allow read: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /service_categories/{categoryId} {
      allow read: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /packages/{packageId} {
      allow read: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /promotions/{promotionId} {
      allow read: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /last_minute_slots/{slotId} {
      allow read: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /appointment_day_checklists/{checklistId} {
      allow read: if isSignedIn() && (
        (resourceSalonId() != null && canManageSalonDocument(resourceSalonId())) ||
        isAdminOrStaff()
      );

      allow create: if isSignedIn() && isAdminOrStaff() &&
          requestSalonId() != null &&
          canManageSalonDocument(requestSalonId()) ;

      allow update: if isSignedIn() && isAdminOrStaff() &&
          resourceSalonId() != null &&
          requestSalonId() == resourceSalonId() &&
          canManageSalonDocument(resourceSalonId());

      allow delete: if isSignedIn() && isAdminOrStaff() &&
          resourceSalonId() != null &&
          canManageSalonDocument(resourceSalonId());
    }

    match /quotes/{quoteId} {
      allow read: if isSignedIn() && (
        canManageSalonDocument(resourceSalonId()) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string &&
            isOwnClient(resource.data.clientId))
      );

      allow create: if isSignedIn() &&
          requestSalonId() != null &&
          canManageSalonDocument(requestSalonId());

      allow update: if isSignedIn() && (
        (
          canManageSalonDocument(resourceSalonId()) &&
          requestSalonId() == resourceSalonId()
        ) || quoteDecisionAllowedForClient()
      );

      allow delete: if isSignedIn() && canManageSalonDocument(resourceSalonId());
    }

    match /appointments/{appointmentId} {
      allow read: if isSignedIn() && (
        (resourceSalonId() != null && canManageSalonDocument(resourceSalonId())) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string && isOwnClient(resource.data.clientId))
      );

      allow create: if isSignedIn() && requestSalonId() != null && (
        canManageSalonDocument(requestSalonId()) ||
        (requestClientId() != null && isOwnClient(requestClientId()) &&
            hasSalonAccess(requestSalonId()))
      );

      allow update: if isSignedIn() && resourceSalonId() != null && requestSalonId() == resourceSalonId() && (
        canManageSalonDocument(resourceSalonId()) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string && isOwnClient(resource.data.clientId))
      );

      allow delete: if isSignedIn() && resourceSalonId() != null && (
        canManageSalonDocument(resourceSalonId()) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string && isOwnClient(resource.data.clientId))
      );
    }

    match /inventory/{itemId} {
      allow read: if isSignedIn() && canManageSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /sales/{saleId} {
      allow read: if isSignedIn() && (
        canManageSalonDocument(resourceSalonId()) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string &&
            isOwnClient(resource.data.clientId))
      );
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /payment_tickets/{ticketId} {
      allow read: if isSignedIn() && (
        canManageSalonDocument(resourceSalonId()) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string &&
            isOwnClient(resource.data.clientId))
      );
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId()) &&
          (request.method != 'update' || requestSalonId() == resourceSalonId());
    }

    match /client_photos/{photoId} {
      allow read: if isSignedIn() && (
        canManageSalonDocument(resourceSalonId()) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string &&
            isOwnClient(resource.data.clientId))
      );
      allow create: if isSignedIn() &&
          canManageSalonDocument(requestSalonId()) &&
          requestClientId() != null &&
          requestSalonId() != null &&
          hasSalonAccess(requestSalonId());
      allow delete: if isSignedIn() && canManageSalonDocument(resourceSalonId());
      allow update: if false;
    }
    match /client_photo_collages/{collageId} {
      allow read: if isSignedIn() && (
        canManageSalonDocument(resourceSalonId()) ||
        (resource != null && resource.data != null &&
            resource.data.clientId is string &&
            isOwnClient(resource.data.clientId))
      );
      allow create: if isSignedIn() &&
          canManageSalonDocument(requestSalonId()) &&
          requestClientId() != null &&
          requestSalonId() != null &&
          hasSalonAccess(requestSalonId());
      allow delete: if isSignedIn() && canManageSalonDocument(resourceSalonId());
      allow update: if false;
    }

    match /salon_sequences/{salonId} {
      allow read: if isSignedIn();

      allow create: if false;

      allow update: if false;

      allow delete: if false;
    }

    match /cash_flows/{entryId} {
      allow read: if isSignedIn() && canManageSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /message_templates/{templateId} {
      allow read: if isSignedIn() && canManageSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /reminder_settings/{salonId} {
      allow read: if isSignedIn() && canReadSalonDocument(salonId);
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(salonId);
    }

    match /salons/{salonId}/settings/reminders {
      allow read: if isSignedIn() && canReadSalonDocument(salonId);
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(salonId);
    }

    match /message_outbox/{messageId} {
      allow read: if isSignedIn() && (
        canManageSalonDocument(resourceSalonId()) ||
        (isClient() &&
            resource != null &&
            resource.data != null &&
            resource.data.clientId is string &&
            resource.data.clientId == currentClientId())
      );
      allow update: if isSignedIn() &&
          isClient() &&
          resource != null &&
          resource.data != null &&
          resource.data.clientId is string &&
          resource.data.clientId == currentClientId() &&
          request.resource != null &&
          request.resource.data.clientId == resource.data.clientId &&
          request.writeFields.hasOnly(['readAt']);
    }

    match /shifts/{shiftId} {
      allow read: if isSignedIn() && canReadSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /staff_absences/{absenceId} {
      allow read: if isSignedIn() && canManageSalonDocument(resourceSalonId());
      allow create, update, delete: if isSignedIn() &&
          canManageSalonDocument(request.resource != null && request.resource.data != null &&
              request.resource.data.salonId is string
              ? request.resource.data.salonId
              : resourceSalonId());
    }

    match /public_appointments/{appointmentId} {
      allow read: if isSignedIn() && resourceSalonId() != null && hasSalonAccess(resourceSalonId());

      allow create, update: if isSignedIn() && requestSalonId() != null && hasSalonAccess(requestSalonId()) &&
          appointmentSalonId(appointmentId) != null &&
          appointmentSalonId(appointmentId) == requestSalonId() &&
          (
            canManageSalonDocument(requestSalonId()) ||
            (appointmentClient(appointmentId) != null &&
                isOwnClient(appointmentClient(appointmentId)))
          );

      allow delete: if isSignedIn() && appointmentSalonId(appointmentId) != null &&
          hasSalonAccess(appointmentSalonId(appointmentId)) &&
          (
            canManageSalonDocument(appointmentSalonId(appointmentId)) ||
            (appointmentClient(appointmentId) != null &&
                isOwnClient(appointmentClient(appointmentId)))
          );
    }

    match /public_staff_absences/{absenceId} {
      allow read: if isSignedIn() && resourceSalonId() != null && hasSalonAccess(resourceSalonId());
      allow create, update, delete: if isSignedIn() && (
        (requestSalonId() != null && canManageSalonDocument(requestSalonId())) ||
        (requestSalonId() == null && resourceSalonId() != null && canManageSalonDocument(resourceSalonId()))
      );
    }

    match /carts/{cartId} {
      allow read: if isSignedIn() && (
        (resource != null && resource.data != null && resource.data.clientId is string &&
            isOwnClient(resource.data.clientId)) ||
        (resourceSalonId() != null && canManageSalonDocument(resourceSalonId()))
      );

      allow create: if isSignedIn() && request.resource != null && request.resource.data != null &&
        request.resource.data.clientId is string &&
        request.resource.data.salonId is string &&
        request.resource.data.status is string &&
        ['pending', 'submitted'].hasAny([request.resource.data.status]) &&
        isOwnClient(request.resource.data.clientId) &&
        hasSalonAccess(request.resource.data.salonId);

      allow update: if isSignedIn() && (
        (resourceSalonId() != null && canManageSalonDocument(resourceSalonId())) ||
        (
          resource != null && resource.data != null &&
          request.resource != null && request.resource.data != null &&
          resource.data.clientId is string && request.resource.data.clientId == resource.data.clientId &&
          resource.data.salonId is string && request.resource.data.salonId == resource.data.salonId &&
          isOwnClient(resource.data.clientId) &&
          isCartStatusEditable(resource.data.status) &&
          isCartStatusEditable(request.resource.data.status)
        )
      );

      allow delete: if isSignedIn() && (
        (resourceSalonId() != null && canManageSalonDocument(resourceSalonId())) ||
        (resource != null && resource.data != null && resource.data.clientId is string &&
            isOwnClient(resource.data.clientId))
      );
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
